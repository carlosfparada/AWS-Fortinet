---

# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/expect_module.html
# https://www.mail-archive.com/ansible-project@googlegroups.com/msg39525.html 
- name: Set admin initial password
  ansible.builtin.expect:
    command: "ssh -o StrictHostKeyChecking=no admin@{{ groups['fortigate'][0] }}"
    responses:
      # 'Are you sure you want to continue connecting (yes/no/[fingerprint])': "yes"
      # 'You are forced to change your password. Please input a new password.'
      's password:': "{{ hostvars[groups['fortigate'][0]].instance_id }}" 
      'New Password:': "{{ new_password }}" 
      'Confirm Password:': "{{ new_password }}"
      'FGT': "exit"
  no_log: false # hide passwords on logs
  ignore_errors: true
  #delegate_to: localhost

- name: Wait 5 seconds
  wait_for:
    timeout: 5
  delegate_to: localhost

#https://docs.fortinet.com/document/fortigate/7.4.0/administration-guide/399023/rest-api-administrator
#https://docs.fortinet.com/document/fortigate/6.2.15/cookbook/294491/administrator-profiles
- name: Create a REST API administrator (CLI)
  ansible.builtin.expect:
    command: "ssh -o StrictHostKeyChecking=no admin@{{ groups['fortigate'][0] }}"
    responses:
      'password:': "{{ new_password }}" 
      'FGT': "{{ api_config }}"
  register: output
  delegate_to: localhost

- name: Set Fortigate Token variable
  set_fact:
    fortigate_token: "{{ item.split(' ')[3] }}"
  loop: "{{ output.stdout_lines }}"
  when: "'New API key' in item"
  delegate_to: localhost

# - name: Change admin password
#   ansible.builtin.expect:
#     command: "ssh -o StrictHostKeyChecking=no admin@{{ groups['fortigate'][0] }}"
#     responses:
#       '.* password:': "{{ init_password }}" 
#       'FortiGate-VM64 # ': "config system admin"
#       'FortiGate-VM64 \(admin\) #':
#         - "edit admin"
#         - "set password {{ new_password }}"
#         - "end"
#   no_log: false # hide passwords on logs 
      
# - name: Update VM license
#   ansible.builtin.expect:
#     command: "ssh -o StrictHostKeyChecking=no admin@{{ hostvars[groups['fortigate'][0]].ansible_host }}"
#     responses:
#       '.* password': "{{ new_password }}" 
#       'FortiGate-VM64 # ': "execute restore vmlicense ftp {{ lic_filemame }} {{ lic_ftp_server }}"
#       'Do you want to continue\? \(y/n\)': "y"
#   no_log: false # hide passwords on logs 
#   timeout: 60
#   ignore_errors: yes